# =============================================
# NGINX KONFIGURACIJA - Load Balancer
# =============================================
# Ova konfiguracija:
# 1. Raspoređuje zahteve između replika (round-robin)
# 2. Proverava zdravlje svake replike
# 3. Automatski isključuje replike koje ne rade
# 4. Vraća repliku u rotaciju kada ozdravi
# =============================================

# Broj worker procesa (auto = koliko ima CPU jezgara)
worker_processes auto;

# Konfiguracija događaja
events {
    worker_connections 1024;
}

http {
    # =========================================
    # UPSTREAM - Definicija backend servera
    # =========================================
    # Ovde definišemo replike koje primaju zahteve
    # NGINX će raspoređivati zahteve između njih
    # =========================================
    upstream jutjubic_backend {
        # Round-robin load balancing (default)
        # Zahtevi se raspoređuju redom: R1, R2, R1, R2...

        # Replika 1
        # max_fails=3  - nakon 3 neuspela zahteva, označi kao "down"
        # fail_timeout=30s - koliko dugo ostaje "down" pre ponovne provere
        server app-replica-1:8080 max_fails=3 fail_timeout=30s;

        # Replika 2
        server app-replica-2:8080 max_fails=3 fail_timeout=30s;

        # Opciono: keepalive konekcije za bolje performanse
        keepalive 32;
    }

    upstream jutjubic_ws {
        ip_hash;
        server app-replica-1:8080 max_fails=3 fail_timeout=30s;
        server app-replica-2:8080 max_fails=3 fail_timeout=30s;
    }

    # =========================================
    # LOG FORMAT
    # =========================================
    # Custom log format koji uključuje informacije
    # o tome koja replika je odgovorila
    # =========================================
    log_format upstream_log '$remote_addr - $remote_user [$time_local] '
                            '"$request" $status $body_bytes_sent '
                            '"$http_referer" "$http_user_agent" '
                            'upstream: $upstream_addr '
                            'response_time: $upstream_response_time';

    access_log /var/log/nginx/access.log upstream_log;
    error_log /var/log/nginx/error.log;

    # =========================================
    # GLAVNI SERVER BLOK
    # =========================================
    server {
        listen 80;
        server_name localhost;

        # Maksimalna veličina upload-a (za video fajlove)
        client_max_body_size 250M;

        # Timeout podešavanja za velike fajlove
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;

        # -----------------------------------------
        # HEALTH CHECK ENDPOINT ZA NGINX
        # -----------------------------------------
        # Ovo je endpoint za proveru da li NGINX radi
        # Docker koristi ovo za healthcheck
        # -----------------------------------------
        location /health {
            access_log off;
            return 200 'NGINX is healthy\n';
            add_header Content-Type text/plain;
        }

        # -----------------------------------------
        # LOAD BALANCER STATUS
        # -----------------------------------------
        # Endpoint koji pokazuje koja replika je aktivna
        # Koristan za debugging
        # -----------------------------------------
        location /lb-status {
            access_log off;
            return 200 'Load Balancer Active - Upstream: jutjubic_backend\n';
            add_header Content-Type text/plain;
        }

        # -----------------------------------------
        # API ZAHTEVI
        # -----------------------------------------
        # Svi /api/* zahtevi idu na backend replike
        # -----------------------------------------
        location /api/ {
            proxy_pass http://jutjubic_backend;

            # Prosleđivanje headera
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # BITNO: Prosleđivanje Authorization headera za JWT
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;

            # Header koji pokazuje preko kog NGINX-a je zahtev prošao
            add_header X-Upstream-Server $upstream_addr;

            # Retry na drugu repliku ako prva ne odgovori
            proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;

            # HTTP/1.1 za keepalive
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # -----------------------------------------
        # ACTUATOR ENDPOINTS
        # -----------------------------------------
        # Health check endpointi za monitoring
        # -----------------------------------------
        location /actuator/ {
            proxy_pass http://jutjubic_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            add_header X-Upstream-Server $upstream_addr;
        }

        # -----------------------------------------
        # UPLOAD FAJLOVI (thumbnails, videi)
        # -----------------------------------------
        location /uploads/ {
            proxy_pass http://jutjubic_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header X-Upstream-Server $upstream_addr;
        }

        # -----------------------------------------
        # MEDIA FAJLOVI
        # -----------------------------------------
        location /media/ {
            proxy_pass http://jutjubic_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            add_header X-Upstream-Server $upstream_addr;
        }

        # -----------------------------------------
        # WEBSOCKET - Live Chat
        # -----------------------------------------
        location /ws {
            proxy_pass http://jutjubic_ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 86400;
        }

        # -----------------------------------------
        # CORS za Angular frontend
        # -----------------------------------------
        # Ako frontend trči na drugom portu
        # -----------------------------------------
        location / {
            # Ako ima frontend, može se dodati proxy_pass
            # Za sada vraćamo info poruku
            return 200 'Jutjubic API Gateway\nUse /api/* for API calls\n';
            add_header Content-Type text/plain;
        }
    }
}
